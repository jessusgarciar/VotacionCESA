{% extends "base.html" %}

{% block content %}
<div class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Resultados</h2>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Total de Votos</div>
        <div id="statTotalVotes" class="h4 mt-1">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Votantes Elegibles</div>
        <div id="statEligibleVoters" class="h4 mt-1">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Participación</div>
        <div id="statParticipation" class="h4 mt-1">0.0%</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Estado</div>
        <div id="statStatus" class="h4 mt-1">Activa</div>
      </div>
    </div>
  </div>

    <!-- Pestañas tipo switch (Votar / Resultados / Blockchain) -->
  <div class="d-flex justify-content-center mb-4">
    <div class="btn-group" role="group" aria-label="Navegación principal">
      <a href="{% url 'home' %}" class="btn btn-outline-secondary">Votar</a>
      <a href="{% url 'resultados' %}" class="btn" style="background:#233d7a; color:#fff;">Resultados</a>
  <a href="{% url 'blockchain' %}" class="btn btn-outline-secondary">Blockchain</a>
    </div>
  </div>

  <div id="resultsGrid" class="row row-cols-1 row-cols-md-3 g-4">
    <!-- results injected by JS -->
  </div>

  <div id="transactionTabWrapper" class="card mt-4 d-none">
    <div class="card-header pb-0 border-bottom-0">
      <div class="d-flex align-items-center mb-3">
        <h5 class="mb-0 me-auto" id="transactionTabTitle">Detalle de transacción</h5>
        <button type="button" class="btn-close" id="closeTransactionTab" aria-label="Cerrar pestaña"></button>
      </div>
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="transactionTabButton" data-bs-toggle="tab" data-bs-target="#transactionTabPane" type="button" role="tab">
            Información
          </button>
        </li>
      </ul>
    </div>
    <div class="card-body border-top tab-content" id="transactionTabContent">
      <div class="tab-pane fade show active" id="transactionTabPane" role="tabpanel" aria-labelledby="transactionTabButton">
        <p class="text-muted mb-0" id="transactionTabBody">Selecciona un hash para ver su detalle.</p>
      </div>
    </div>
  </div>


  <script>
    async function fetchAndRenderResults(containerId, electionId=null){
      try{
        const url = new URL('{% url "api_candidates" %}', window.location.origin);
        if(electionId) url.searchParams.set('election_id', electionId);
        const res = await fetch(url);
        const json = await res.json();
        const candidates = json.candidates || [];
        const total = candidates.reduce((s,c)=>s+(c.votes_count||0),0) || 0;
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const palette = ['#0d6efd', '#198754', '#fd7e14', '#6f42c1', '#dc3545', '#0dcaf0'];
        candidates.forEach((c, idx) => {
          const color = palette[idx % palette.length];
          const pct = total? ((c.votes_count/total)*100).toFixed(1):0;
          const col = document.createElement('div');
          col.className = 'col';
          const card = document.createElement('div');
          card.className = 'card candidate-card h-100 shadow-sm';
          const image = c.image_url || 'https://picsum.photos/seed/default/800/260';
          const proposals = (c.manifesto||'').split('\n').slice(0,3).map(x=>`<li>${x}</li>`).join('');
          card.innerHTML = `\
            <img src="${image}" class="card-img-top" alt="${c.name}">\
            <div class="card-body">\
              <h5 class="card-title">${c.list_name}</h5>\
              <p class="small text-muted">Propuestas principales:</p>\
              <ul class="small">${proposals}</ul>\
            </div>\
            <div class="card-footer bg-white border-top-0">\
              <div class="d-flex justify-content-between align-items-center mb-2">\
                <small class="text-muted">Votos</small>\
                <small class="text-muted votes-count">${c.votes_count} (${pct}%)</small>\
              </div>\
              <div class="progress" style="height:10px">\
                <div class="progress-bar" role="progressbar" style="width:${pct}%;background:${color}" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>\
              </div>\
              <div class="mt-3 d-flex justify-content-end">\
                <a href="#" class="btn btn-sm details-btn" style="background:${color};color:#fff;border:none" data-color="${color}" data-bs-toggle="modal" data-candidate-id="${c.id}" data-name="${c.name}" data-list="${c.list_name}" data-image="${image}" data-proposals="${(c.manifesto||'').replace(/\n/g,';')}" data-members="">Detalles</a>\
              </div>\
            </div>`;
          col.appendChild(card);
          // attach members data as JSON to the button dataset so modal can render them
          try{
            const btn = card.querySelector('.details-btn');
            if(btn){ btn.dataset.members = JSON.stringify(c.members || []); btn.dataset.color = color; }
          }catch(e){ console.warn('could not attach members', e); }
          container.appendChild(col);
        });
      }catch(err){
        console.error('Error rendering results', err);
      }
    }

    async function initResults(){
      try{
        const resE = await fetch('{% url "api_elections" %}');
        const jsonE = await resE.json();
        const elections = jsonE.elections || [];
        const active = elections.find(e=>e.is_active) || elections[0] || null;
        const electionId = active? active.id : null;
        fetchAndRenderResults('resultsGrid', electionId);
      }catch(e){
        console.warn('Could not load elections', e);
        fetchAndRenderResults('resultsGrid');
      }
    }

    function formatTransactionValue(value){
      if(value == null) return '<span class="text-muted">N/D</span>';
      if(typeof value === 'object'){
        return `<pre class="bg-light rounded p-2 mb-0">${JSON.stringify(value, null, 2)}</pre>`;
      }
      return String(value);
    }

    function renderTransactionDetails(data={}, sourceEl=null){
      const wrapper = document.getElementById('transactionTabWrapper');
      const body = document.getElementById('transactionTabBody');
      const title = document.getElementById('transactionTabTitle');
      if(!wrapper || !body) return;
      wrapper.classList.remove('d-none');
      const entries = Object.entries(data || {});
      if(entries.length){
        body.innerHTML = entries.map(([key,val])=>`
          <div class="py-2 border-bottom">
            <div class="small text-uppercase text-muted fw-semibold">${key}</div>
            <div class="text-break">${formatTransactionValue(val)}</div>
          </div>`).join('');
      }else{
        body.innerHTML = '<p class="text-muted mb-0">Sin datos de transacción.</p>';
      }
      if(title){
        const hash = data.hash || data.tx_hash || sourceEl?.textContent?.trim();
        title.textContent = hash ? `Transacción ${hash}` : 'Detalle de transacción';
      }
      if(typeof wrapper.scrollIntoView === 'function'){
        wrapper.scrollIntoView({behavior:'smooth', block:'start'});
      }
      const tabBtn = document.getElementById('transactionTabButton');
      if(window.bootstrap && tabBtn){
        window.bootstrap.Tab.getOrCreateInstance(tabBtn).show();
      }
    }

    async function handleHashClick(hashEl){
      let data = null;
      if(hashEl.dataset.transaction){
        try{
          data = JSON.parse(hashEl.dataset.transaction);
        }catch(err){
          console.warn('Transacción inválida', err);
        }
      }
      if(!data && hashEl.dataset.transactionUrl){
        try{
          const res = await fetch(hashEl.dataset.transactionUrl);
          data = await res.json();
        }catch(err){
          console.warn('No se pudo cargar la transacción', err);
        }
      }
      if(!data){
        data = { hash: hashEl.textContent?.trim() };
      }
      renderTransactionDetails(data, hashEl);
    }

    function hideTransactionTab(){
      const wrapper = document.getElementById('transactionTabWrapper');
      if(wrapper){
        wrapper.classList.add('d-none');
      }
    }

    document.addEventListener('click', function(ev){
      const hashEl = ev.target.closest('.hash-link');
      if(hashEl){
        ev.preventDefault();
        handleHashClick(hashEl);
      }
    });

    document.addEventListener('DOMContentLoaded', function(){
      initResults();
      const closeTabBtn = document.getElementById('closeTransactionTab');
      if(closeTabBtn){
        closeTabBtn.addEventListener('click', hideTransactionTab);
      }
      // also load stats for the active election
      (async function loadStats(){
        try{
          const resE = await fetch('{% url "api_elections" %}');
          const jsonE = await resE.json();
          const elections = jsonE.elections || [];
          const active = elections.find(e=>e.is_active) || elections[0] || null;
          const electionId = active? active.id : null;
          const url = new URL('{% url "api_stats" %}', window.location.origin);
          if(electionId) url.searchParams.set('election_id', electionId);
          const resS = await fetch(url);
          const stats = await resS.json();
          const totalEl = document.getElementById('statTotalVotes');
          const eligibleEl = document.getElementById('statEligibleVoters');
          const partEl = document.getElementById('statParticipation');
          const statusEl = document.getElementById('statStatus');
          if(totalEl) totalEl.textContent = stats.total_votes ?? totalEl.textContent;
          if(eligibleEl) eligibleEl.textContent = stats.eligible_voters ?? eligibleEl.textContent;
          if(partEl) partEl.textContent = (stats.participation != null ? stats.participation + '%' : partEl.textContent);
          if(statusEl) {
            const isActive = !!(active && active.is_active);
            statusEl.textContent = isActive ? 'Activa' : 'Cerrada';
            statusEl.classList.remove('text-success','text-danger');
            statusEl.classList.add(isActive ? 'text-success' : 'text-danger');
          }
        }catch(e){ console.warn('Could not load stats', e); }
      })();
    });
  </script>
</div>
{% endblock %}
