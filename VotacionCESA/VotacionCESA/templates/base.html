<!doctype html>
{% load static %}
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Votaci贸n CESA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <style>
    /* Small custom styles to better match the design */
    .topbar {
      background: #233d7a; /* requested navbar color */
      color: white;
    }
    .brand-title { font-weight:700; }
    .stats-card { border-radius: .75rem; }
    .candidate-card img { height: 260px; object-fit: cover; }
    .vote-btn { background: #0b1226; color: #fff; }
    .badge-blockchain { background: rgba(255,255,255,0.12); color: #fff; border-radius: .5rem; padding:.35rem .6rem; }
    .proposal-number {
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      line-height: 1;
      flex: 0 0 36px;
    }
  </style>
</head>
<body class="bg-light">

  {% block header %}
  <header class="topbar py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center">
          <img id="navLogo" src="{% static 'logo.png' %}" alt="Logo" width="36" height="36" class="me-2" style="object-fit:contain;" href="/" />
          <script>
            (function(){
              try{
                var img = document.getElementById('navLogo');
                if(!img) return;
                img.addEventListener('error', function(){
                  try{
                    // try loading a bundled SVG fallback
                    this.src = '{% static "logo.svg" %}';
                  }catch(e){
                    // last-resort: hide image
                    this.style.display = 'none';
                  }
                });
              }catch(e){/* silent */}
            })();
          </script>
        </div>
        <div>
          <div class="brand-title" href="/">Sistema de Votaci贸n CESA</div>
          <small class="d-block" style="opacity:.9">Powered by Algorand Blockchain</small>
        </div>
      </div>

  <div class="d-flex align-items-center gap-3">
        <div class="badge-blockchain">Blockchain Verificado</div>
          {% if user.is_authenticated %}
          {% if user.is_staff %}
            <nav class="me-3">
              <ul class="nav">
                <li class="nav-item"><a class="nav-link text-light" href="/manage/create-user/">Crear usuario</a></li>
                <li class="nav-item"><a class="nav-link text-light" href="/manage/create-voter/">Agregar votante</a></li>
                <li class="nav-item"><a class="nav-link text-light" href="/manage/create-candidate/">Crear planilla</a></li>
              </ul>
            </nav>
          {% endif %}
          <div class="text-end">
            <div>{{ user.voter.control_number|default:user.username }}</div>
            <small>Votante verificado</small>
          </div>
          <form method="post" action="{% url 'logout' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-light">Cerrar sesi贸n</button>
          </form>
          {% else %}
          <a class="btn btn-sm btn-light" href="{% url 'login' %}">Iniciar sesi贸n</a>
        {% endif %}
      </div>
    </div>
  </header>
  {% endblock %}

  <main class="py-5">
    <div class="container">
      {% block content %}
      {% endblock %}
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <style>
    /* Make the small nav buttons inside the topbar use the navbar color */
    .topbar .btn-group .btn,
    .topbar .btn-group .btn.btn-outline-secondary,
    .topbar .btn-group .btn.btn-primary {
      background: #233d7a;
      color: #fff;
      border-color: #233d7a;
    }
    .topbar .btn-group .btn:hover {
      filter: brightness(0.95);
    }
    .topbar .nav-link.text-light {
      color: #fff !important;
    }
  </style>

  <!-- Candidate details / voting modal -->
  <div class="modal fade" id="candidateModal" tabindex="-1" aria-labelledby="candidateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="candidateModalLabel"></h5>
            <small class="text-muted" id="candidateSubtitle"></small>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4 text-center mb-3">
              <img id="candidateImage" src="" alt="Foto" class="img-fluid rounded" style="max-height:160px; object-fit:cover;">
            </div>
            <div class="col-md-8">
              <h5 id="candidateName">Nombre</h5>
              <p class="text-muted" id="candidateList">Lista</p>

              <hr>
              <h6 class="mb-3">Integrantes de la Planilla</h6>
              <div id="candidateMembers" class="row g-3">
                <!-- Member cards injected here -->
              </div>

              <hr class="mt-4">
              <h6 class="mb-3">Propuestas Principales</h6>
              <div id="candidateProposals" class="row g-3">
                <!-- Proposals injected here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="confirmVoteBtn" class="btn btn-success">Confirmar voto</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Modal logic: populate from data-* attributes on buttons
  document.addEventListener('click', function(e){
      const btn = e.target.closest('.vote-btn, .details-btn');
      if(!btn) return;
      e.preventDefault();
      const name = btn.dataset.name || '';
      const list = btn.dataset.list || '';
      const image = btn.dataset.image || '';
      const proposals = (btn.dataset.proposals || '').split(';').filter(Boolean);

      // Fill modal fields
  // Header: show the candidate name as the modal title and the planilla (list) below
  document.getElementById('candidateModalLabel').textContent = name;
  // keep subtitle empty
  document.getElementById('candidateSubtitle').textContent = '';
  // show name in the header and the list name as secondary text in the body
  document.getElementById('candidateName').textContent = name;
  document.getElementById('candidateList').textContent = list;
      document.getElementById('candidateImage').src = image;

      // Populate members from data-members (JSON encoded) if present
      const membersEl = document.getElementById('candidateMembers');
      membersEl.innerHTML = '';
      try{
        const membersJson = btn.dataset.members || btn.getAttribute('data-members') || '[]';
        const members = JSON.parse(membersJson || '[]');
        if(Array.isArray(members) && members.length>0){
          const candidateColor = btn.dataset.color || btn.getAttribute('data-color') || '#198754';
          members.forEach(m => {
            const memberCard = document.createElement('div');
            memberCard.className = 'col-md-6';
            const roleBadge = m.role? `<small class="badge mb-1" style="background:${candidateColor};color:#fff">${m.role}</small>` : '';
            // Compute initials (first letters of up to two name parts)
            const nameParts = (m.full_name || '').split(/\s+/).filter(Boolean);
            const initials = (nameParts.slice(0,2).map(p => p[0].toUpperCase()).join('')) || '?';
            // Render a circular avatar with initials instead of a photo
            memberCard.innerHTML = `<div class="card p-3"><div class="d-flex"><div class="me-3 d-flex align-items-center justify-content-center rounded-circle bg-secondary text-white fw-bold" style="width:64px;height:64px;">${initials}</div><div>${roleBadge}<div class="fw-semibold">${m.full_name}</div><div class="small text-muted">&nbsp;</div></div></div></div>`;
            membersEl.appendChild(memberCard);
          });
        }else{
          // fallback: show the main candidate as presidente
          const memberCard = document.createElement('div');
          memberCard.className = 'col-md-6';
          // Fallback: show circular initials avatar for president
          const presParts = (name || '').split(/\s+/).filter(Boolean);
          const presInitials = (presParts.slice(0,2).map(p => p[0].toUpperCase()).join('')) || '?';
          const candidateColor = btn.dataset.color || btn.getAttribute('data-color') || '#198754';
          memberCard.innerHTML = `<div class="card p-3"><div class="d-flex"><div class="me-3 d-flex align-items-center justify-content-center rounded-circle bg-secondary text-white fw-bold" style="width:64px;height:64px;">${presInitials}</div><div><small class="badge mb-1" style="background:${candidateColor};color:#fff">Presidente</small><div class="fw-semibold">${name}</div><div class="small text-muted">Cargo / Facultad</div></div></div></div>`;
          membersEl.appendChild(memberCard);
        }
      }catch(e){
        console.warn('Invalid members JSON', e);
        membersEl.innerHTML = '';
      }

      // Populate proposals
      const proposalsEl = document.getElementById('candidateProposals');
      proposalsEl.innerHTML = '';
        const proposalColor = btn.dataset.color || btn.getAttribute('data-color') || '#198754';
        proposals.forEach((p, idx) => {
        const col = document.createElement('div');
        col.className = 'col-md-6';
        col.innerHTML = `<div class="card p-3"><div class="d-flex align-items-start gap-3"><div class="proposal-number" style="background:${proposalColor};color:#fff;">${idx+1}</div><div class="small">${p}</div></div></div>`;
        proposalsEl.appendChild(col);
      });

      // Show modal
      const modalEl = document.getElementById('candidateModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Confirm vote logic (POST to /api/vote/)
      const confirmBtn = document.getElementById('confirmVoteBtn');
    // style the confirm button using the candidate's color if provided
    const candidateColor = btn.dataset.color || btn.getAttribute('data-color') || '#198754';
    confirmBtn.classList.remove('btn-success');
    confirmBtn.style.background = candidateColor;
    confirmBtn.style.color = '#fff';
    confirmBtn.style.border = 'none';
    confirmBtn.textContent = `Confirmar Voto por ${name}`;
      confirmBtn.disabled = false;
      // remove previous onclick handlers
      confirmBtn.onclick = null;
      confirmBtn.addEventListener('click', function onConfirm() {
        // disable to avoid double clicks
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Enviando...';

        // candidate id should be in the triggering button's data attribute
        const candidateId = btn.dataset.candidateId || btn.dataset.candidateId === 0 ? btn.dataset.candidateId : null;
        if(!candidateId){
          confirmBtn.textContent = 'Error: candidato desconocido';
            setTimeout(() => { confirmBtn.disabled = false; confirmBtn.textContent = `Confirmar Voto por ${name}`; }, 1200);
          return;
        }

        // CSRF helper
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // send POST
        fetch('{% url "api_vote" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
          },
          body: new URLSearchParams({ 'candidate_id': candidateId })
        }).then(r => {
          if(!r.ok) throw r;
          return r.json();
        }).then(json => {
          confirmBtn.textContent = 'Voto confirmado';
          // update UI: refresh candidate counts using returned values
          try{
            const candidateCount = json.candidate_votes;
            const total = json.total_votes;
            const candidateId = (btn.dataset.candidateId || btn.dataset.candidateId === 0) ? btn.dataset.candidateId : null;
            if(candidateId){
              // update any .votes-count inside cards for this candidate
              document.querySelectorAll(`[data-candidate-id="${candidateId}"]`).forEach(el=>{
                const card = el.closest('.card');
                if(!card) return;
                const votesEl = card.querySelector('.votes-count');
                if(votesEl){
                  const pct = total? ((candidateCount/total)*100).toFixed(1):0;
                  votesEl.textContent = `${candidateCount} (${pct}%)`;
                  const bar = card.querySelector('.progress-bar');
                  if(bar){
                    bar.style.width = pct + '%';
                    bar.setAttribute('aria-valuenow', pct);
                  }
                }
              });
            }
          }catch(e){console.warn('Could not update counts', e)}
          // close modal after short delay
          setTimeout(() => modal.hide(), 900);
        }).catch(async err => {
          let msg = 'Error al procesar el voto';
          try{
            const text = await err.text();
            msg = text || msg;
          }catch(e){}
          alert(msg);
          confirmBtn.disabled = false;
          confirmBtn.textContent = `Confirmar Voto por ${name}`;
        }).finally(()=>{
          // remove this handler to avoid multiple listeners if modal reopened
          confirmBtn.removeEventListener('click', onConfirm);
        });
      });
    });
  </script>
</body>
</html>