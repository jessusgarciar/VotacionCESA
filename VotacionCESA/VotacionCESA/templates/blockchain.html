{% extends "base.html" %}

{% block content %}
<div class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Explorador de Blockchain</h2>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Total de Votos</div>
        <div id="statTotalVotes" class="h4 mt-1">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Votantes Elegibles</div>
        <div id="statEligibleVoters" class="h4 mt-1">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Participaci贸n</div>
        <div id="statParticipation" class="h4 mt-1">0.0%</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card p-3">
        <div class="small text-muted">Estado</div>
        <div id="statStatus" class="h4 mt-1">Activa</div>
      </div>
    </div>
  </div>

  <!-- Pesta帽as tipo switch (Votar / Resultados / Blockchain) - Blockchain activo -->
  <div class="d-flex justify-content-center mb-4">
    <div class="btn-group" role="group" aria-label="Navegaci贸n principal">
      <a href="{% url 'home' %}" class="btn btn-outline-secondary">Votar</a>
      <a href="{% url 'resultados' %}" class="btn btn-outline-secondary">Resultados</a>
      <a href="{% url 'blockchain' %}" class="btn" style="background:#233d7a; color:#fff;">Blockchain</a>
    </div>
  </div>

  <div class="card shadow-sm">
      <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h5 class="card-title mb-1"><i class="bi bi-hdd-stack"></i> Explorador de Blockchain</h5>
          <p class="small text-muted mb-0">Visualiza las transacciones (tokens) registradas para las votaciones.</p>
        </div>
        <div>
          <span id="txCountBadge" class="badge bg-light text-dark">0 Transacciones</span>
        </div>
      </div>

      <!-- Estado vac铆o / tabla de transacciones
      <div class="text-center py-5">
        <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="mb-3 text-muted" style="opacity:.7">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v6a4 4 0 004 4h10"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 7v6a4 4 0 01-4 4H7"/>
        </svg>
        <h5 class="text-muted">No hay transacciones registradas a煤n</h5>
        <p class="small text-muted">Cuando haya votaciones activas y tokens emitidos, aqu铆 aparecer谩n las transacciones verificadas por la red Algorand.</p>
      </div>

      <div class="mt-4 p-3 rounded" style="background:#f1f7ff;">
        <small class="text-muted"> Todas las transacciones son inmutables y est谩n verificadas por la red Algorand</small>
      </div>
    </div>
  </div>
  -->

  <!-- Ejemplo de tabla (oculto ya que no hay transacciones) -->
  <!-- -- Tabla de transacciones -->
  <div class="card mt-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Hash</th>
              <th>Tipo</th>
              <th>Votaci贸n</th>
              <th>Fecha</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="txTableBody">
            <!-- Transaction rows populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="transactionTabWrapper" class="card mt-4 d-none">
    <div class="card-header pb-0 border-bottom-0">
      <div class="d-flex align-items-center mb-3">
        <h5 class="mb-0 me-auto" id="transactionTabTitle">Detalle de transacci贸n</h5>
        <button type="button" class="btn-close" id="closeTransactionTab" aria-label="Cerrar pesta帽a"></button>
      </div>
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="transactionTabButton" data-bs-toggle="tab" data-bs-target="#transactionTabPane" type="button" role="tab">
            Informaci贸n
          </button>
        </li>
      </ul>
    </div>
    <div class="card-body border-top tab-content" id="transactionTabContent">
      <div class="tab-pane fade show active" id="transactionTabPane" role="tabpanel" aria-labelledby="transactionTabButton">
        <p class="text-muted mb-0" id="transactionTabBody">Selecciona un hash para ver su detalle.</p>
      </div>
    </div>
  </div>

  <script>
    async function initCandidates(){
      try{
        // fetch elections and pick active one
        const resE = await fetch('{% url "api_elections" %}');
        const jsonE = await resE.json();
        const elections = jsonE.elections || [];
        const active = elections.find(e=>e.is_active) || elections[0] || null;
        const electionId = active? active.id : null;
        fetchAndRenderCandidates('candidatesGrid', electionId);
      }catch(e){
        console.warn('Could not load elections', e);
        fetchAndRenderCandidates('candidatesGrid');
      }
    }

      document.addEventListener('DOMContentLoaded', function(){
      initCandidates();
      // also load stats for the active election
      (async function loadStats(){
        try{
          const resE = await fetch('{% url "api_elections" %}');
          const jsonE = await resE.json();
          const elections = jsonE.elections || [];
          const active = elections.find(e=>e.is_active) || elections[0] || null;
          const electionId = active? active.id : null;
          const url = new URL('{% url "api_stats" %}', window.location.origin);
          if(electionId) url.searchParams.set('election_id', electionId);
          const resS = await fetch(url);
          const stats = await resS.json();
          const totalEl = document.getElementById('statTotalVotes');
          const eligibleEl = document.getElementById('statEligibleVoters');
          const partEl = document.getElementById('statParticipation');
          const statusEl = document.getElementById('statStatus');
          if(totalEl) totalEl.textContent = stats.total_votes ?? totalEl.textContent;
          if(eligibleEl) eligibleEl.textContent = stats.eligible_voters ?? eligibleEl.textContent;
          if(partEl) partEl.textContent = (stats.participation != null ? stats.participation + '%' : partEl.textContent);
          if(statusEl) {
            const isActive = !!(active && active.is_active);
            statusEl.textContent = isActive ? 'Activa' : 'Cerrada';
            statusEl.classList.remove('text-success','text-danger');
            statusEl.classList.add(isActive ? 'text-success' : 'text-danger');
          }
        }catch(e){ console.warn('Could not load stats', e); }
      })();
    });

  </script>
  <script>
    // Fetch recent OnChainRecord entries and render them into the table
    async function loadBlockchainRecords(){
      try{
        const res = await fetch('{% url "api_blockchain_records" %}');
        const json = await res.json();
        const records = json.records || [];
        const tbody = document.getElementById('txTableBody');
        const badge = document.getElementById('txCountBadge');
        if(badge) badge.textContent = `${records.length} Transacciones`;
        if(!tbody) return;
        tbody.innerHTML = '';
        for(const r of records){
          const tr = document.createElement('tr');
          const txTd = document.createElement('td');
          const txLink = document.createElement('a');
          txLink.href = '#';
          txLink.className = 'hash-link text-decoration-none';
          txLink.innerHTML = `<code>${r.txid.substring(0,8)}...${r.txid.slice(-8)}</code>`;
          txLink.dataset.transaction = JSON.stringify(r);
          txTd.appendChild(txLink);
          const typeTd = document.createElement('td');
          typeTd.textContent = 'VoteTx';
          const voteTd = document.createElement('td');
          voteTd.textContent = r.election || (r.candidate || 'N/A');
          const timeTd = document.createElement('td');
          timeTd.textContent = new Date(r.timestamp).toLocaleString();
          const statusTd = document.createElement('td');
          statusTd.innerHTML = `<span class="badge bg-success">${r.status}</span>`;
          tr.appendChild(txTd);
          tr.appendChild(typeTd);
          tr.appendChild(voteTd);
          tr.appendChild(timeTd);
          tr.appendChild(statusTd);
          tbody.appendChild(tr);
        }
      }catch(e){
        console.warn('Could not load blockchain records', e);
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      loadBlockchainRecords();
    });
  </script>

  <script>
    function formatTransactionValue(value){
      if(value == null) return '<span class="text-muted">N/D</span>';
      if(typeof value === 'object'){
        return `<pre class="bg-light rounded p-2 mb-0">${JSON.stringify(value, null, 2)}</pre>`;
      }
      return String(value);
    }

    function renderTransactionDetails(data={}, sourceEl=null){
      const wrapper = document.getElementById('transactionTabWrapper');
      const body = document.getElementById('transactionTabBody');
      const title = document.getElementById('transactionTabTitle');
      if(!wrapper || !body) return;
      wrapper.classList.remove('d-none');
      const entries = Object.entries(data || {});
      if(entries.length){
        body.innerHTML = entries.map(([key,val])=>`
          <div class="py-2 border-bottom">
            <div class="small text-uppercase text-muted fw-semibold">${key}</div>
            <div class="text-break">${formatTransactionValue(val)}</div>
          </div>`).join('');
      }else{
        body.innerHTML = '<p class="text-muted mb-0">Sin datos de transacci贸n.</p>';
      }
      if(title){
        const hash = data.txid || data.hash || sourceEl?.textContent?.trim();
        title.textContent = hash ? `Transacci贸n ${hash}` : 'Detalle de transacci贸n';
      }
      if(typeof wrapper.scrollIntoView === 'function'){
        wrapper.scrollIntoView({behavior:'smooth', block:'start'});
      }
      const tabBtn = document.getElementById('transactionTabButton');
      if(window.bootstrap && tabBtn){
        window.bootstrap.Tab.getOrCreateInstance(tabBtn).show();
      }
    }

    function hideTransactionTab(){
      const wrapper = document.getElementById('transactionTabWrapper');
      if(wrapper){
        wrapper.classList.add('d-none');
      }
    }

    document.addEventListener('click', function(ev){
      const hashEl = ev.target.closest('.hash-link');
      if(hashEl){
        ev.preventDefault();
        let data = null;
        if(hashEl.dataset.transaction){
          try{
            data = JSON.parse(hashEl.dataset.transaction);
          }catch(err){
            console.warn('Transacci贸n inv谩lida', err);
          }
        }
        if(!data){
          data = { hash: hashEl.textContent?.trim() };
        }
        renderTransactionDetails(data, hashEl);
      }
    });

    document.addEventListener('DOMContentLoaded', function(){
      const closeTabBtn = document.getElementById('closeTransactionTab');
      if(closeTabBtn){
        closeTabBtn.addEventListener('click', hideTransactionTab);
      }
    });
  </script>
</div>
{% endblock %}
